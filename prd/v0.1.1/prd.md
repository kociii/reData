# reData v0.1.1 产品需求文档

**版本**: v0.1.1
**基于版本**: v0.1.0
**目标**: 优化数据处理交互体验，完善项目设置功能，增加全局设置支持

---

## 一、数据处理交互优化

### 1.1 左侧任务列表重构

将任务列表按状态分为三个分组：

| 分组 | 状态包含 | 说明 |
|------|----------|------|
| 待处理 | `pending` | 用户选择了文件但还未开始处理 |
| 处理中 | `processing`, `paused`, `queued` | 正在处理 + 队列等待 + 暂停恢复等待 |
| 已完成 | `completed`, `cancelled` | 已完成/已取消的任务 |

**交互设计：**
- 每个分组可折叠/展开
- 显示每个分组内的任务数量
- 当前选中任务高亮显示
- 支持多选（用于批量操作）

### 1.2 右侧对话式交互

将现有的进度条 + 日志区域改为对话式流式展示：

**展示内容：**

1. **AI 分析过程**（流式）
   - 显示 AI 分析列映射时的思考过程
   - 展示发送给 AI 的数据样本
   - 流式显示 AI 返回内容

2. **状态卡片流**
   - 每个处理阶段作为独立卡片展示
   - 阶段顺序：准备中 → AI 识别 → 数据导入 → 完成
   - 卡片状态：待处理（灰色）、进行中（蓝色脉冲）、已完成（绿色）、错误（红色）

3. **处理日志流**
   - 日志以对话气泡形式展示
   - 区分系统消息（左对齐）和进度消息（右对齐）
   - 错误日志醒目标识
   - 支持滚动查看历史记录

**状态隔离：**
- 切换到另一个任务时，保留上一个任务的进度状态
- 再次切换回来时，恢复之前的展示状态
- 后台任务继续执行，只是 UI 展示切换

### 1.3 任务控制增强

**单独操作：**
- 启动：从待处理状态开始执行
- 暂停：暂停正在处理的任务
- 恢复：从暂停状态恢复执行
- 取消：取消任务（不可恢复）

**批量操作：**
- 批量启动：选中多个待处理任务，一键全部启动
- 批量暂停：选中多个处理中任务，一键全部暂停
- 批量取消：选中多个任务，一键全部取消

---

## 二、项目数据统计和危险操作

### 2.1 数据统计

在项目设置页面展示以下统计数据：

| 统计项 | 数据来源 | 说明 |
|--------|----------|------|
| 总记录数 | `get_record_count` | 项目中的总记录数 |
| 今日新增 | 按日期过滤查询 | 今天导入的记录数 |
| 本周新增 | 按日期过滤查询 | 最近 7 天导入的记录数 |
| 本月新增 | 按日期过滤查询 | 最近 30 天导入的记录数 |
| 处理任务数 | `list_processing_tasks` | 历史总任务数 |
| 成功率 | 成功数/总数 | 数据处理成功率 |

### 2.2 危险操作

| 操作 | 说明 | 确认机制 |
|------|------|----------|
| 清空项目数据 | 删除项目下所有记录，保留项目配置 | 二次确认对话框 + 输入项目名称 |
| 导出配置 | 导出项目配置和字段定义为 JSON 文件 | 直接下载 |
| 导出数据 | 导出所有记录为 Excel/CSV 文件 | 选择格式后下载 |

**实现说明：**
- 清空数据：后端已有 `delete_project_records` 命令，前端直接调用
- 导出配置：需要新增后端命令 `export_project_config`
- 导出数据：需要新增后端命令 `export_project_data`

---

## 三、全局设置支持

### 3.1 配置项

在全局设置页面（`/settings`）支持以下配置：

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| AI 配置管理 | 多选一 | - | 管理多个 AI 配置，设置默认配置 |
| 并行处理数 | 数字 | 3 | 同时处理的文件数量（1-10） |
| 主题设置 | 枚举 | system | 深色/浅色/跟随系统 |
| 自动保存 | 布尔 | true | 处理完成后自动保存结果 |
| 重复数据处理 | 枚举 | skip | skip(跳过)/update(更新)/merge(合并) |

### 3.2 持久化方案

- 使用 Tauri 的 `tauri-plugin-store` 插件存储全局设置
- 配置文件位置：`~/.redata/settings.json`
- 项目级设置继续使用数据库存储

### 3.3 配置生效范围

- **全局设置**：对所有新建项目生效
- **项目设置**：优先级高于全局设置，可单独配置

---

## 四、技术要点

### 4.1 状态管理优化

```
ProcessingStore 结构调整：
- pendingTasks: ProcessingTask[]     // 待处理
- activeTasks: ProcessingTask[]      // 处理中
- completedTasks: ProcessingTask[]   // 已完成
- taskDetails: Map<taskId, TaskDetail>  // 每个任务的详细状态（隔离存储）
- selectedTasks: Set<taskId>         // 多选的任务 ID
```

### 4.2 事件系统扩展

扩展现有的 `processing-progress` 事件，增加：
- `ai_thinking`: AI 思考过程（流式）
- `ai_response`: AI 返回内容（流式）

### 4.3 后端新增命令

| 命令 | 功能 |
|------|------|
| `export_project_config` | 导出项目配置为 JSON |
| `export_project_data` | 导出项目数据为 Excel/CSV |
| `get_project_statistics` | 获取项目统计数据 |
| `get_global_settings` | 获取全局设置 |
| `save_global_settings` | 保存全局设置 |

---

## 五、验证方式

1. **数据处理页面**
   - 验证三状态分组显示正确
   - 验证对话式流式展示效果
   - 验证任务切换状态隔离
   - 验证批量操作功能

2. **项目设置页面**
   - 验证统计数据实时更新
   - 验证清空数据功能
   - 验证导出配置/数据功能

3. **全局设置页面**
   - 验证配置项持久化
   - 验证配置项对新建项目生效
